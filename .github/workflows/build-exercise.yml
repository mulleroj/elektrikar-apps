name: Process App ZIP

on:
  push:
    paths:
      - "uploads/*.zip"
  workflow_dispatch:
    inputs:
      zip_name:
        description: "Name of the ZIP file in uploads folder"
        required: true

jobs:
  build-exercise:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Process ZIP files
        run: |
          shopt -s nullglob
          processed=false

          for zip_file in uploads/*.zip; do
            echo "üì¶ Processing: $zip_file"
            
            # Get exercise name from filename (sanitize)
            basename=$(basename "$zip_file" .zip)
            safename=$(echo "$basename" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g; s/--*/-/g; s/^-//; s/-$//')
            
            echo "üìã Exercise name: $safename"
            
            # Create temp directory and extract
            tmpdir=$(mktemp -d)
            unzip -o "$zip_file" -d "$tmpdir"
            
            # Find the actual project root (handle ZIP with single subdirectory)
            entries=($(ls -1 "$tmpdir" | grep -v '^\.' ))
            if [ ${#entries[@]} -eq 1 ] && [ -d "$tmpdir/${entries[0]}" ]; then
              projectdir="$tmpdir/${entries[0]}"
              echo "üìÅ Found subdirectory: ${entries[0]}"
            else
              projectdir="$tmpdir"
            fi
            
            # Check for index.html
            if [ ! -f "$projectdir/index.html" ]; then
              # Try common subdirectories
              for subdir in dist build out public; do
                if [ -f "$projectdir/$subdir/index.html" ]; then
                  projectdir="$projectdir/$subdir"
                  echo "üìÅ Using subdirectory: $subdir"
                  break
                fi
              done
            fi
            
            if [ ! -f "$projectdir/index.html" ]; then
              echo "‚ùå No index.html found in $basename, skipping"
              rm -rf "$tmpdir"
              continue
            fi

            # Validate index.html is not empty
            if [ ! -s "$projectdir/index.html" ]; then
              echo "‚ùå index.html is empty in $basename, skipping"
              rm -rf "$tmpdir"
              continue
            fi
            
            echo "‚úÖ Found valid index.html ($(wc -c < "$projectdir/index.html") bytes)"
            
            # Copy to exercises folder (remove node_modules, .git, etc.)
            targetdir="exercises/$safename"
            rm -rf "$targetdir"
            mkdir -p "$targetdir"
            
            # Copy files, excluding unnecessary directories
            rsync -a --exclude='node_modules' --exclude='.git' --exclude='.github' \
                      --exclude='package-lock.json' --exclude='.env' \
                      "$projectdir/" "$targetdir/"
            
            echo "üìÅ Copied to $targetdir"
            
            # Create/update meta.json
            description=$(echo "$basename" | sed 's/-/ /g')
            cat > "$targetdir/meta.json" <<EOF
          {
            "id": "$safename",
            "name": "$basename",
            "description": "$description",
            "icon": "‚ö°",
            "created": "$(date +%Y-%m-%d)",
            "folder": "$safename",
            "isBuilt": true
          }
          EOF
            
            # Remove processed ZIP
            rm "$zip_file"
            processed=true
            echo "‚úÖ Done: $safename"
            echo ""
          done

          if [ "$processed" = false ]; then
            echo "‚ö†Ô∏è No ZIP files found to process"
          fi

      - name: Update manifest
        run: |
          # Build manifest from meta.json files
          echo '{"exercises":[' > exercises/manifest.json.tmp
          first=true
          for meta in exercises/*/meta.json; do
            if [ -f "$meta" ]; then
              if [ "$first" = false ]; then
                echo ',' >> exercises/manifest.json.tmp
              fi
              cat "$meta" >> exercises/manifest.json.tmp
              first=false
            fi
          done
          echo ']}' >> exercises/manifest.json.tmp

          # Pretty-print with python (available on ubuntu)
          python3 -c "
          import json, sys
          with open('exercises/manifest.json.tmp') as f:
              data = json.load(f)
          with open('exercises/manifest.json', 'w') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          "
          rm exercises/manifest.json.tmp

          echo "üìã Manifest updated:"
          cat exercises/manifest.json

      - name: Commit built apps
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add exercises/
          git add uploads/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "‚ö° Auto-build: P≈ôid√°na nov√° aplikace"
            git push
          fi
